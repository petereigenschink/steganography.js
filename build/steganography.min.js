/*
 * steganography.js v1.0.4 2018-11-14
 *
 * Copyright (C) 2018 Peter Eigenschink (http://www.peter-eigenschink.at/) and Contributors
 * Dual-licensed under MIT and Beerware license.
*/

!function(t,e,r){"undefined"!=typeof module&&module.exports?module.exports=r():"function"==typeof define&&define.amd?define(r):e.steg=r()}(0,this,function(){var t=function(){},L={isPrime:function(t){if(isNaN(t)||!isFinite(t)||t%1||t<2)return!1;if(t%2==0)return 2===t;if(t%3==0)return 3===t;for(var e=Math.sqrt(t),r=5;r<=e;r+=6){if(t%r==0)return!1;if(t%(r+2)==0)return!1}return!0},findNextPrime:function(t){for(var e=t;;e+=1)if(L.isPrime(e))return e},sum:function(t,e,r){for(var n=0,i=(r=r||{}).start||0;i<e;i+=r.inc||1)n+=t(i)||0;return 0===n&&r.defValue?r.defValue:n},product:function(t,e,r){for(var n=1,i=(r=r||{}).start||0;i<e;i+=r.inc||1)n*=t(i)||1;return 1===n&&r.defValue?r.defValue:n},createArrayFromArgs:function(t,e,r){for(var n=new Array(r-1),i=0;i<r;i+=1)n[i]=t(e<=i?i+1:i);return n},loadImg:function(t){var e=new Image;return e.src=t,e}};return t.prototype.config={t:3,threshold:1,codeUnitSize:16,args:function(t){return t+1},messageDelimiter:function(t,e){for(var r=new Array(3*e),n=0;n<r.length;n+=1)r[n]=255;return r},messageCompleted:function(t,e,r){for(var n=!0,i=0;i<16&&n;i+=1)n=n&&255===t[e+4*i];return n}},t.prototype.getHidingCapacity=function(t,e){e=e||{};var r=this.config,n=e.width||t.width||t.naturalWidth,i=e.height||t.height||t.naturalHeight;return(e.t||r.t)*n*i/(e.codeUnitSize||r.codeUnitSize)>>0},t.prototype.encode=function(t,e,r){if(e.length)e=L.loadImg(e);else if(e.src)e=L.loadImg(e.src);else if(!(e instanceof HTMLImageElement))throw new Error("IllegalInput: The input image is neither an URL string nor an image.");r=r||{};var n=this.config,i=r.t||n.t,a=r.threshold||n.threshold,o=r.codeUnitSize||n.codeUnitSize,h=L.findNextPrime(Math.pow(2,i)),g=r.args||n.args,d=r.messageDelimiter||n.messageDelimiter;if(!i||i<1||7<i)throw new Error('IllegalOptions: Parameter t = " + t + " is not valid: 0 < t < 8');var l=document.createElement("canvas"),f=l.getContext("2d");l.style.display="none",l.width=r.width||e.width||e.naturalWidth,l.height=r.height||e.height||e.naturalHeight,r.height&&r.width?f.drawImage(e,0,0,r.width,r.height):f.drawImage(e,0,0);var s,u,m,c,p,w,v,I,M,y=f.getImageData(0,0,l.width,l.height),C=y.data,U=o/i>>0,S=o%i,E=[];for(I=0;I<=t.length;I+=1){if(p=t.charCodeAt(I)||0,0<(w=S*I%i)&&u){if(m=(p&(v=Math.pow(2,i-w)-1))<<w,c=(u&Math.pow(2,o)*(1-Math.pow(2,-w)))>>o-w,E.push(m+c),I<t.length){for(v=Math.pow(2,2*i-w)*(1-Math.pow(2,-i)),M=1;M<U;M+=1)s=p&v,E.push(s>>(M-1)*i+(i-w)),v<<=i;S*(I+1)%i==0?(s=p&(v=Math.pow(2,o)*(1-Math.pow(2,-i))),E.push(s>>o-i)):S*(I+1)%i+(i-w)<=i&&(s=p&v,E.push(s>>(U-1)*i+(i-w)))}}else if(I<t.length)for(v=Math.pow(2,i)-1,M=0;M<U;M+=1)s=p&v,E.push(s>>M*i),v<<=i;u=p}var x,z,D,P,H,A=d(E,a);for(x=0;4*(x+a)<=C.length&&x+a<=E.length;x+=a){for(H=[],I=0;I<a&&I+x<E.length;I+=1){for(P=0,M=x;M<a+x&&M<E.length;M+=1)P+=E[M]*Math.pow(g(I),M-x);H[I]=255-h+1+P%h}for(I=4*x;I<4*(x+H.length)&&I<C.length;I+=4)C[I+3]=H[I/4%a];D=H.length}for(z=x+D;z-(x+D)<A.length&&4*(x+A.length)<C.length;z+=1)C[4*z+3]=A[z-(x+D)];for(I=4*(z+1)+3;I<C.length;I+=4)C[I]=255;return y.data=C,f.putImageData(y,0,0),l.toDataURL()},t.prototype.decode=function(t,e){if(t.length)t=L.loadImg(t);else if(t.src)t=L.loadImg(t.src);else if(!(t instanceof HTMLImageElement))throw new Error("IllegalInput: The input image is neither an URL string nor an image.");e=e||{};var r=this.config,n=e.t||r.t,i=e.threshold||r.threshold,a=e.codeUnitSize||r.codeUnitSize,o=L.findNextPrime(Math.pow(2,n)),h=(e.args||r.args,e.messageCompleted||r.messageCompleted);if(!n||n<1||7<n)throw new Error('IllegalOptions: Parameter t = " + t + " is not valid: 0 < t < 8');var g=document.createElement("canvas"),d=g.getContext("2d");g.style.display="none",g.width=e.width||t.width||t.naturalWidth,g.height=e.width||t.height||t.naturalHeight,e.height&&e.width?d.drawImage(t,0,0,e.width,e.height):d.drawImage(t,0,0);var l,f,s=d.getImageData(0,0,g.width,g.height).data,u=[];if(1===i)for(f=!(l=3);!f&&l<s.length&&!f;l+=4)(f=h(s,l,i))||u.push(s[l]-(255-o+1));var m="",c=0,p=0,w=Math.pow(2,a)-1;for(l=0;l<u.length;l+=1)c+=u[l]<<p,a<=(p+=n)&&(m+=String.fromCharCode(c&w),p%=a,c=u[l]>>n-p);return 0!==c&&(m+=String.fromCharCode(c&w)),m},new t});